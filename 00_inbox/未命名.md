


```dataviewjs
// 初始化一个数组来存储所有未完成的待办事项
let allTasks = [];

// 遍历所有文件，筛选出未完成的任务
for (let page of dv.pages()) {
    // 获取当前页面的任务
    let tasks = page.file.tasks;

    // 筛选未完成的任务并添加到 allTasks 数组中
    for (let task of tasks) {
        if (!task.completed) {
            allTasks.push({
                text: task.text,
                file: page.file.name, // 记录任务所在文件名
                path: page.file.path,  // 记录文件路径
                task: task             // 记录原始任务对象
            });
        }
    }
}

// 输出所有未完成的任务
if (allTasks.length > 0) {
    // 创建表格展示未完成的任务
    dv.table(["任务", "文件", "操作"], allTasks.map(task => [
        task.text,
        task.path,
        `- [ ] 任务完成` // 添加可勾选的复选框
    ]));

    // 添加事件监听器以处理复选框勾选事件
    allTasks.forEach((task, index) => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `task-${index}`;
        
        // 添加事件监听器
        checkbox.addEventListener('change', async () => {
            if (checkbox.checked) {
                // 更新任务为已完成状态
                console.log(`任务 "${task.text}" 在 "${task.file}" 中已完成`);

                // 更新原文件中的任务状态
                const filePath = task.path;
                const fileContent = await app.vault.read(app.vault.getAbstractFileByPath(filePath));
                
                // 使用正则表达式更新任务状态为已完成
                const updatedContent = fileContent.replace(
                    new RegExp(`- \\[ ] ${task.text}`), 
                    `- [x] ${task.text}`
                );

                // 写回更新后的内容到文件
                await app.vault.modify(app.vault.getAbstractFileByPath(filePath), updatedContent);
                
                // 重新加载页面以反映更改（可选）
                location.reload();
            }
        });

        // 确保在表格渲染后再添加复选框
        setTimeout(() => {
            const cell = dv.container.querySelector(`tr:nth-child(${index + 2}) td:last-child`);
            if (cell) { // 确保cell存在
                cell.appendChild(checkbox);
            }
        }, 0); // 使用setTimeout确保DOM已经更新
    });
} else {
    dv.paragraph("没有找到未完成的待办事项。");
}
```